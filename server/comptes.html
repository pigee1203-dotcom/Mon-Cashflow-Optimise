<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comptes & Connexion - Mon Centre de Pilotage Financier</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const connectButton = document.querySelector('.action-button.primary'); // Sélectionne le bouton de connexion

        connectButton.addEventListener('click', async () => {
            // 1. Appel du Back-end pour obtenir le Link Token (Jeton temporaire)
            const response = await fetch('/api/create_link_token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });
            const data = await response.json();
            const linkToken = data.link_token; // Récupère le jeton du serveur

            // 2. Initialisation de Plaid Link
            const handler = Plaid.create({
                token: linkToken,
                onSuccess: (public_token, metadata) => {
                    // Fonction appelée après une connexion réussie
                    // ENVOI du jeton public au Back-end pour l'échange (Étape 2.C)
                    fetch('/api/exchange_public_token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ public_token: public_token }),
                    }).then(res => res.json())
                      .then(result => {
                          alert('Connexion réussie ! Jeton permanent enregistré sur le serveur.');
                          window.location.reload(); // Recharger la page après succès
                      });
                },
                onExit: (err, metadata) => {
                    // Gérer les erreurs (ex: l'utilisateur ferme la fenêtre)
                    console.error('Erreur Plaid Link:', err);
                },
            });

            // 3. Ouvrir l'interface de connexion Plaid
            handler.open();
        });
    });
</script>
<body>

    <header class="header">
        <div class="net-worth">
            <h1>Module : Comptes & Connexion Bancaire</h1>
            <span class="net-value">Gestion de vos liens avec les institutions financières (Plaid)</span>
        </div>
        <a href="index.html" class="sync-button"><i class="fas fa-arrow-left"></i> Retour Dashboard</a>
    </header>

    <div class="main-layout">
        
        <aside class="sidebar">
            <nav class="main-nav">
                <ul>
                    <li><i class="fas fa-chart-line"></i> <a href="index.html">Dashboard</a></li>
                    <li><i class="fas fa-wallet"></i> <a href="#" class="active-link">Comptes</a> (actif)</li>
                    <li><i class="fas fa-hand-holding-usd"></i> <a href="dettes.html">Dettes & Stratégie</a></li>
                    <li><i class="fas fa-piggy-bank"></i> <a href="placements.html">Placements</a></li>
                    </ul>
            </nav>
        </aside>

        <main class="content-grid">
            
            <section class="connection-block card" style="grid-column: 1 / 3; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2>Statut de l'Agrégation de Données</h2>
                    <p style="color: #95A5A6; font-size: 14px;">Utilisation de l'API sécurisée pour la lecture de vos soldes et transactions.</p>
                </div>
                <button class="action-button primary" style="width: 300px; padding: 15px; font-size: 16px;"><i class="fas fa-plus-circle"></i> Connecter un Compte Bancaire</button>
            </section>
            
            <section class="institutions-table card" style="grid-column: 1 / 3; margin-top: 20px;">
                <h2>Vos Institutions Connectées</h2>
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="background-color: #ECF0F1;">
                            <th style="padding: 10px;">Institution</th>
                            <th style="padding: 10px;">Jeton d'Accès (Token)</th>
                            <th style="padding: 10px;">Dernière Synchro</th>
                            <th style="padding: 10px;">Statut</th>
                            <th style="padding: 10px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td style="padding: 10px;">Banque TD Canada Trust</td><td style="padding: 10px; font-size: 12px;">token_td_xxxxxx...</td><td style="padding: 10px;">09/12/2025, 09:35</td><td style="padding: 10px;" class="success"><i class="fas fa-check-circle"></i> OK</td><td style="padding: 10px;"><button style="color: var(--color-alert);">Supprimer</button></td></tr>
                        <tr><td style="padding: 10px;">BMO Ligne de Crédit</td><td style="padding: 10px; font-size: 12px;">token_bmo_xxxxxx...</td><td style="padding: 10px;">Échec de la synchro</td><td style="padding: 10px;" class="urgent"><i class="fas fa-exclamation-triangle"></i> ERREUR</td><td style="padding: 10px;"><button style="color: var(--color-info);">Réparer</button></td></tr>
                        <tr><td style="padding: 10px;">Desjardins (Placements)</td><td style="padding: 10px; font-size: 12px;">token_des_xxxxxx...</td><td style="padding: 10px;">08/12/2025, 14:00</td><td style="padding: 10px;" class="info"><i class="fas fa-clock"></i> OK</td><td style="padding: 10px;"><button style="color: var(--color-alert);">Supprimer</button></td></tr>
                    </tbody>
                </table>
            </section>

            <section class="solde-detail card" style="grid-column: 1 / 2; margin-top: 20px;">
                <h2>Soldes Détaillés des Comptes</h2>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 10px; border-bottom: 1px dashed #ECF0F1; padding-bottom: 10px;">
                        <span style="font-weight: bold;">Compte Chèques TD:</span> <span style="float: right; font-weight: bold; color: var(--color-secondary);">$ 4,520.10</span>
                    </li>
                    <li style="margin-bottom: 10px; border-bottom: 1px dashed #ECF0F1; padding-bottom: 10px;">
                        <span style="font-weight: bold;">Compte Épargne RBC:</span> <span style="float: right; font-weight: bold; color: var(--color-secondary);">$ 12,000.00</span>
                    </li>
                    <li style="margin-bottom: 10px;">
                        <span style="font-weight: bold;">Carte de Crédit Visa:</span> <span style="float: right; font-weight: bold; color: var(--color-alert);">- $ 8,500.00</span>
                    </li>
                </ul>
                <p style="margin-top: 20px; font-size: 12px; color: #95A5A6;">* Les soldes sont affichés en temps réel (ou lors de la dernière synchronisation).</p>
            </section>

            <section class="transactions-log card" style="grid-column: 2 / 3; margin-top: 20px;">
                <h2>Dernières Transactions Brutes</h2>
                <ul style="list-style: none; padding: 0; max-height: 400px; overflow-y: auto;">
                    <li style="margin-bottom: 8px; font-size: 13px;"><span style="color: #95A5A6; margin-right: 5px;">09 Déc</span> Achat Épicerie (IGA) <span style="float: right; color: var(--color-alert);">- $ 98.50</span></li>
                    <li style="margin-bottom: 8px; font-size: 13px;"><span style="color: #95A5A6; margin-right: 5px;">08 Déc</span> Dépôt Salaire <span style="float: right; color: var(--color-secondary);">+ $ 2,500.00</span></li>
                    <li style="margin-bottom: 8px; font-size: 13px;"><span style="color: #95A5A6; margin-right: 5px;">07 Déc</span> Paiement Netflix <span style="float: right; color: var(--color-alert);">- $ 22.99</span></li>
                    </ul>
                <button class="view-all-button" style="margin-top: 10px;">Voir toutes les transactions</button>
            </section>
        
        </main>
    </div>

</body>
</html>
